apiVersion: apps/v1
kind: Deployment
metadata:
  name: bfb-search
  namespace: haloperidol
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: bfb-search
  replicas: 1
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app.kubernetes.io/name: bfb-search
        # These labels are needed to bypass the NetworkPolicy
        app: cluster-manager
        cluster-id: haloperidol
        customer-id: haloperidol
    spec:
      terminationGracePeriodSeconds: 1
      initContainers:
      - name: wait-for-collection
        image: nixery.dev/shell/curl/jq/busybox
        env:
        - name: QDRANT_URL
          value: http://qdrant-haloperidol.haloperidol.svc.cluster.local:6333
        command:
        - /scripts/wait-for-collection.sh
        volumeMounts:
          - name: scripts
            mountPath: /scripts/
      containers:
      - name: bfb-search
        image: qdrant/bfb:latest
        env:
        - name: QDRANT_URL
          value: http://qdrant-haloperidol.haloperidol.svc.cluster.local:6334
        command:
        - /scripts/run-bfb-search.sh
        volumeMounts:
          - name: scripts
            mountPath: /scripts/
      volumes:
      - name: scripts
        configMap:
          # This name must match the configMapGenerator. Kustomize will
          # append a hash to this name based on the content of the scripts
          name: scripts
          defaultMode: 0777
